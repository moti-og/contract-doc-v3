<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SuperDoc Viewer</title>
  <!-- SuperDoc styles (local) -->
  <link href="/vendor/superdoc/style.css" rel="stylesheet" />
  <link rel="icon" href="data:,"/>
  <!-- Preload local React UMD -->
  <link rel="preload" as="script" href="/vendor/react/react.production.min.js" />
  <link rel="preload" as="script" href="/vendor/react/react-dom.production.min.js" />
  <style>
    :root { --banner-h: 140px; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; height: 100vh; }
    #banner { min-height: var(--banner-h); display: flex; align-items: center; justify-content: center; padding: 12px; background: linear-gradient(180deg, #9aa0b4 0%, #98a0ad 100%); color: #fff; box-shadow: 0 2px 12px rgba(0,0,0,0.12) inset, 0 2px 6px rgba(0,0,0,0.08); border-bottom: 1px solid rgba(255,255,255,0.25); }
    .banner-inner { position: relative; width: 100%; max-width: 1024px; display: flex; flex-direction: column; align-items: center; gap: 12px; border-radius: 12px; }
    .pill-left { position: absolute; left: 0; top: 0; transform: translate(12px, -6px); background: #2563eb; color: #fff; padding: 6px 12px; border-radius: 999px; font-size: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
    .banner-title { font-size: 28px; font-weight: 800; text-align: center; text-shadow: 0 1px 1px rgba(0,0,0,0.25); }
    #layout { position: relative; display: flex; height: calc(100vh - var(--banner-h)); }
    #editor-col { position: relative; z-index: 1; display: flex; flex-direction: column; flex: 1; min-width: 0; }
    #superdoc-toolbar { position: relative; z-index: 1; border-bottom: 1px solid #ddd; display: flex; flex-wrap: wrap; gap: 6px; padding: 6px 10px; max-width: 980px; margin: 0 auto; }
    #superdoc { position: relative; z-index: 1; flex: 1; min-height: 0; }
    #pane { position: relative; z-index: 10; width: 360px; max-width: 420px; border-left: 1px solid #eee; display: flex; flex-direction: column; padding-top: 20px; background: #fff; box-shadow: -2px 0 8px rgba(0,0,0,0.08); }
    #app-root { padding: 8px 12px; overflow: auto; background: #fff; }
  </style>
  <!-- React UMD (local) and React entry (shared) -->
  <script defer src="/vendor/react/react.production.min.js"></script>
  <script defer src="/vendor/react/react-dom.production.min.js"></script>
  <script defer src="/ui/components.react.js?v=react-m7"></script>
  <script type="module">
    import { ensureSuperDocLoaded, mountSuperdoc } from '/web/superdoc-init.js?v=ui-actions-4';
    window.addEventListener('load', async () => {
      try {
        // Ensure SuperDoc UMD (with exporter) is available from CDN before mounting
        await ensureSuperDocLoaded();
        // Prefer working overlay if present; otherwise canonical; fallback to default
        const rev = Date.now();
        const candidates = [`/documents/working/default.docx?rev=${rev}`, `/documents/canonical/default.docx?rev=${rev}`, `/documents/default.docx?rev=${rev}`];
        let chosen = null;
        for (const u of candidates) { try { const h = await fetch(u, { method: 'HEAD' }); if (h.ok) { chosen = u; break; } } catch {} }
        if (!chosen) throw new Error('no document available');

        let currentMode = 'editing';
        let currentDoc = chosen;
        let superdocInstance = null;
        let currentBlobUrl = null;
        const mount = (doc) => {
          currentDoc = doc;
          superdocInstance = mountSuperdoc({ selector: '#superdoc', toolbar: '#superdoc-toolbar', document: doc, documentMode: currentMode, pagination: true, rulers: true,
            role: currentMode === 'viewing' ? 'viewer' : (currentMode === 'suggesting' ? 'suggester' : 'editor'),
            modules: { comments: { readOnly: currentMode === 'viewing', allowResolve: true }, toolbar: { responsiveToContainer: true, hideButtons: false } }
          });
          return superdocInstance;
        };
        const render = (doc) => {
          try { if (superdocInstance && typeof superdocInstance.destroy === 'function') { superdocInstance.destroy(); } } catch {}
          superdocInstance = null;
          const oldToolbar = document.getElementById('superdoc-toolbar');
          const oldContainer = document.getElementById('superdoc');
          const newToolbar = document.createElement('div'); newToolbar.id = 'superdoc-toolbar';
          const newContainer = document.createElement('div'); newContainer.id = 'superdoc'; newContainer.style.flex = '1';
          oldToolbar?.replaceWith(newToolbar); oldContainer?.replaceWith(newContainer);
          if (typeof doc === 'string') { try { doc = new URL(doc, location.origin).href; } catch {} }
          mount(doc);
          try { let pill = document.getElementById('mode-badge'); if (!pill) { pill = document.createElement('span'); pill.id = 'mode-badge'; pill.style.cssText = 'margin-left:8px;padding:2px 6px;border:1px solid #ddd;border-radius:10px;font-size:12px;background:#fafafa;'; document.getElementById('superdoc-toolbar')?.appendChild(pill); } pill.textContent = `mode: ${currentMode}`; } catch {}
        };
        // Fetch the initial document as a Blob to avoid any caching layers
        try {
          const initRes = await fetch(currentDoc, { cache: 'no-store' });
          if (!initRes.ok) throw new Error('init download');
          const initBlob = await initRes.blob();
          if (currentBlobUrl) { try { URL.revokeObjectURL(currentBlobUrl); } catch {}
          }
          currentBlobUrl = URL.createObjectURL(initBlob);
          render(currentBlobUrl);
        } catch (err) {
          console.warn('initial render via blob failed, falling back to URL', err);
          render(currentDoc);
        }
        window.addEventListener('superdoc:open-url', async (e) => {
          try {
            const url = e.detail?.url || '/documents/default.docx';
            const res = await fetch(url, { cache: 'no-store' });
            if (!res.ok) throw new Error('download failed');
            const blob = await res.blob();
            if (currentBlobUrl) { try { URL.revokeObjectURL(currentBlobUrl); } catch {}
            }
            currentBlobUrl = URL.createObjectURL(blob);
            render(currentBlobUrl);
          } catch(err) { console.warn('open-url failed', err); }
        });
        window.addEventListener('superdoc:open-file', (e) => { try { const f = e.detail?.file; if (f) render(f); } catch(err) { console.warn('open-file failed', err); } });
        window.addEventListener('superdoc:set-mode', (e) => {
          const m = e.detail?.mode; if (m && ['editing','suggesting','viewing'].includes(m)) {
            currentMode = m; try { if (superdocInstance && typeof superdocInstance.setDocumentMode === 'function') { superdocInstance.setDocumentMode(currentMode); render(currentDoc); } else { render(currentDoc); } let b = document.getElementById('mode-badge'); if (b) b.textContent = `mode: ${currentMode}`; } catch {}
          }
        });
        // Mount the React right pane as the authoritative renderer
        try { if (window.mountReactApp) window.mountReactApp({ rootSelector: '#app-root' }); } catch {}
      } catch (e) {
        const el = document.getElementById('superdoc');
        el.innerHTML = `<div style="padding:16px">Failed to initialize: ${e?.message || e}.<br/>Open <a href="/debug">/debug</a> to verify current document and uploads.</div>`;
        console.error('View init error', e);
      }
    });
  </script>
</head>
<body>
  <div id="banner">
    <div class="banner-inner">
      <span class="pill-left">Coming 2026</span>
      <div class="banner-title">Redline Like You Mean It: The Future of Contracting</div>
    </div>
  </div>
  <div id="layout">
    <div id="editor-col">
      <div id="superdoc-toolbar"></div>
      <div id="superdoc"></div>
    </div>
    <aside id="pane">
      <div id="app-root"></div>
      <div id="react-root"></div>
    </aside>
  </div>
</body>
</html>


