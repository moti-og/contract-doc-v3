<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SuperDoc Viewer</title>
  <!-- SuperDoc styles (local) -->
  <link href="/static/vendor/superdoc/style.css" rel="stylesheet" />
  <link rel="icon" href="data:,"/>
  <style>
    :root { --banner-h: 140px; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      height: 100vh;
    }
    /* Hero banner */
    #banner {
      min-height: var(--banner-h);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      background: linear-gradient(180deg, #9aa0b4 0%, #98a0ad 100%);
      color: #fff;
      box-shadow: 0 2px 12px rgba(0,0,0,0.12) inset, 0 2px 6px rgba(0,0,0,0.08);
      border-bottom: 1px solid rgba(255,255,255,0.25);
    }
    .banner-inner {
      position: relative;
      width: 100%;
      max-width: 1024px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      border-radius: 12px;
    }
    .pill-left {
      position: absolute;
      left: 0;
      top: 0;
      transform: translate(12px, -6px);
      background: #2563eb;
      color: #fff;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .banner-title {
      font-size: 28px;
      font-weight: 800;
      text-align: center;
      text-shadow: 0 1px 1px rgba(0,0,0,0.25);
    }
    #layout { position: relative; display: flex; height: calc(100vh - var(--banner-h)); }
    #editor-col { position: relative; z-index: 1; display: flex; flex-direction: column; flex: 1; min-width: 0; }
    #superdoc-toolbar {
      position: relative;
      z-index: 1;
      border-bottom: 1px solid #ddd;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 6px 10px;
      max-width: 980px;   /* keep the toolbar from stretching full width */
      margin: 0 auto;     /* center within the editor column */
    }
    #superdoc { position: relative; z-index: 1; flex: 1; min-height: 0; }
    #pane { position: relative; z-index: 10; width: 360px; max-width: 420px; border-left: 1px solid #eee; display: flex; flex-direction: column; padding-top: 20px; background: #fff; box-shadow: -2px 0 8px rgba(0,0,0,0.08); }
    #app-root { padding: 8px 12px; overflow: auto; background: #fff; }
  </style>
  <!-- Load local SuperDoc UMD before module init -->
  <script src="/static/vendor/superdoc/superdoc.umd.min.js"></script>
  <!-- React UMD for shared UI layer -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script type="module">
    import { mountSuperdoc } from '/static/superdoc-init.js?v=ui-actions-3';
    import { mountApp } from '/static/ui/components.js?v=ui-actions-3';
    window.addEventListener('load', async () => {
      try {
        console.log('SuperDoc globals', {
          SuperDoc: typeof window.SuperDoc,
          SuperDocLibrary: typeof window.SuperDocLibrary,
          superdocKeys: Object.keys(window.superdoc || {}),
        });
        const res = await fetch('/documents/default.docx', { method: 'HEAD' });
        if (!res.ok) throw new Error('default.docx not found');

        // Probe collab backend (non-blocking for now)
        try {
          const health = await fetch('/api/v1/health').then(r => r.json()).catch(() => null);
          const httpUrl = health?.superdoc || 'http://localhost:4002';
          const wsUrl = httpUrl.replace(/^http(s)?:\/\//, (m, s) => s ? 'wss://' : 'ws://');
          const sock = new WebSocket(wsUrl);
          sock.onopen = () => console.log('Collab WS connected', wsUrl);
          sock.onerror = (e) => console.warn('Collab WS error', e);
          sock.onclose = () => console.log('Collab WS closed');
        } catch (e) {
          console.warn('Collab probe failed', e);
        }

        // Mount SuperDoc with the default document URL
        let currentMode = 'editing';
        let currentDoc = '/documents/default.docx';
        let superdocInstance = null;
        const mount = (doc) => {
          currentDoc = doc;
          superdocInstance = mountSuperdoc({
            selector: '#superdoc',
            toolbar: '#superdoc-toolbar',
            document: doc,
            documentMode: currentMode,
            pagination: true,
            rulers: true,
            role: currentMode === 'viewing' ? 'viewer' : (currentMode === 'suggesting' ? 'suggester' : 'editor'),
            // Enable SuperDoc modules; comments enables suggestion affordances
            modules: {
              comments: {
                readOnly: currentMode === 'viewing',
                allowResolve: true,
              },
              toolbar: {
                responsiveToContainer: true,
                hideButtons: false,
              }
            }
          });
          return superdocInstance;
        };
        const editorCol = document.getElementById('editor-col');
        const render = (doc) => {
          console.log('Render SuperDoc with', doc);
          // Replace toolbar/editor nodes entirely to guarantee a clean mount
          const oldToolbar = document.getElementById('superdoc-toolbar');
          const oldContainer = document.getElementById('superdoc');
          const newToolbar = document.createElement('div'); newToolbar.id = 'superdoc-toolbar';
          const newContainer = document.createElement('div'); newContainer.id = 'superdoc';
          newContainer.style.flex = '1';
          oldToolbar?.replaceWith(newToolbar);
          oldContainer?.replaceWith(newContainer);
          // Normalize URL to absolute
          if (typeof doc === 'string') {
            try { doc = new URL(doc, location.origin).href; } catch {}
          }
          mount(doc);
          // Add/update mode badge
          try {
            const badgeId = 'mode-badge';
            let pill = document.getElementById(badgeId);
            if (!pill) {
              pill = document.createElement('span');
              pill.id = badgeId;
              pill.style.cssText = 'margin-left:8px;padding:2px 6px;border:1px solid #ddd;border-radius:10px;font-size:12px;background:#fafafa;';
              document.getElementById('superdoc-toolbar')?.appendChild(pill);
            }
            pill.textContent = `mode: ${currentMode}`;
          } catch {}
        };
        // Update finalize banner from state matrix
        const updateFinalizeBanner = async () => {
          try {
            console.log('[banner] fetching state-matrix for banner');
            const r = await fetch('/api/v1/state-matrix?platform=web&userId=user1');
            const j = await r.json();
            const banner = j?.config?.finalize?.banner;
            const top = document.getElementById('banner');
            if (top && banner) {
              const title = document.querySelector('.banner-title');
              const pill = document.querySelector('.pill-left');
              if (title) title.textContent = `${banner.title}: ${banner.message}`;
              if (pill) pill.textContent = banner.title === 'Finalized' ? 'Finalized' : 'Draft';
              console.log('[banner] updated:', banner);
            }
          } catch {}
        };
        // Initial load
        render(currentDoc);
        updateFinalizeBanner();
        // Listen for UI requests to open other docs
        window.addEventListener('superdoc:open-url', (e) => {
          try { render(e.detail?.url || '/documents/default.docx'); } catch(err) { console.warn('open-url failed', err); }
        });
        window.addEventListener('superdoc:open-file', (e) => {
          try { const f = e.detail?.file; if (f) render(f); } catch(err) { console.warn('open-file failed', err); }
        });
        window.addEventListener('superdoc:set-mode', (e) => {
          const m = e.detail?.mode;
          if (m && ['editing','suggesting','viewing'].includes(m)) {
            currentMode = m;
            try {
              if (superdocInstance && typeof superdocInstance.setDocumentMode === 'function') {
                superdocInstance.setDocumentMode(currentMode);
                // Remount to apply module configs (e.g., comments readOnly) tied to mode
                render(currentDoc);
              } else {
                // Fallback: remount if instance API not available
                render(currentDoc);
              }
              // Update badge and banner
              try { const b = document.getElementById('mode-badge'); if (b) b.textContent = `mode: ${currentMode}`; } catch {}
              updateFinalizeBanner();
            } catch { /* ignore */ }
          }
        });
        // SSE to refresh banner on finalize/unfinalize
        try {
          const es = new EventSource('/api/v1/events');
          es.onopen = () => console.log('[banner] SSE open');
          es.onerror = (e) => console.warn('[banner] SSE error', e);
          es.onmessage = (ev) => {
            try {
              const p = JSON.parse(ev.data);
              if (p?.type === 'finalize') {
                console.log('[banner] finalize event', p);
                updateFinalizeBanner();
              }
            } catch (e) { console.warn('[banner] parse err', e); }
          };
        } catch (e) { console.warn('[banner] SSE init failed', e); }
        // Mount shared UI in footer area
        mountApp({ rootSelector: '#app-root' });
      } catch (e) {
        const el = document.getElementById('superdoc');
        el.innerHTML = `<div style=\"padding:16px\">Failed to initialize: ${e?.message || e}.<br/>Open <a href=\"/debug\">/debug</a> to verify current document and uploads.</div>`;
        console.error('View init error', e);
      }
    });
  </script>
</head>
<body>
  <div id="banner">
    <div class="banner-inner">
      <span class="pill-left">Coming 2026</span>
      <!-- Optional logo could go here -->
      <div class="banner-title">Redline Like You Mean It: The Future of Contracting</div>
    </div>
  </div>
  <div id="layout">
    <div id="editor-col">
      <div id="superdoc-toolbar"></div>
      <div id="superdoc"></div>
    </div>
    <aside id="pane">
      <div id="app-root"></div>
    </aside>
  </div>
</body>
</html>

