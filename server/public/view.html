<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SuperDoc Viewer</title>
  <!-- SuperDoc styles (local) -->
  <link href="/static/vendor/superdoc/style.css" rel="stylesheet" />
  <link rel="icon" href="data:,"/>
  <style>
    :root { --banner-h: 140px; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      height: 100vh;
    }
    /* Hero banner */
    #banner {
      min-height: var(--banner-h);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      background: linear-gradient(180deg, #9aa0b4 0%, #98a0ad 100%);
      color: #fff;
      box-shadow: 0 2px 12px rgba(0,0,0,0.12) inset, 0 2px 6px rgba(0,0,0,0.08);
      border-bottom: 1px solid rgba(255,255,255,0.25);
    }
    .banner-inner {
      position: relative;
      width: 100%;
      max-width: 1024px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      border-radius: 12px;
    }
    .pill-left {
      position: absolute;
      left: 0;
      top: 0;
      transform: translate(12px, -6px);
      background: #2563eb;
      color: #fff;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .banner-title {
      font-size: 28px;
      font-weight: 800;
      text-align: center;
      text-shadow: 0 1px 1px rgba(0,0,0,0.25);
    }
    #layout { display: flex; height: calc(100vh - var(--banner-h)); }
    #editor-col { display: flex; flex-direction: column; flex: 1; min-width: 0; }
    #superdoc-toolbar { border-bottom: 1px solid #ddd; }
    #superdoc { flex: 1; min-height: 0; }
    #pane { width: 360px; max-width: 420px; border-left: 1px solid #eee; display: flex; flex-direction: column; padding-top: 20px; }
    #app-root { padding: 8px 12px; overflow: auto; }
  </style>
  <!-- Load local SuperDoc UMD before module init -->
  <script src="/static/vendor/superdoc/superdoc.umd.min.js"></script>
  <!-- React UMD for shared UI layer -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script type="module">
    import { mountSuperdoc } from '/static/superdoc-init.js?v=ui-actions-2';
    import { mountApp } from '/static/ui/components.js?v=ui-actions-2';
    window.addEventListener('load', async () => {
      try {
        console.log('SuperDoc globals', {
          SuperDoc: typeof window.SuperDoc,
          SuperDocLibrary: typeof window.SuperDocLibrary,
          superdocKeys: Object.keys(window.superdoc || {}),
        });
        const res = await fetch('/documents/default.docx', { method: 'HEAD' });
        if (!res.ok) throw new Error('default.docx not found');

        // Probe collab backend (non-blocking for now)
        try {
          const health = await fetch('/api/v1/health').then(r => r.json()).catch(() => null);
          const httpUrl = health?.superdoc || 'http://localhost:4002';
          const wsUrl = httpUrl.replace(/^http(s)?:\/\//, (m, s) => s ? 'wss://' : 'ws://');
          const sock = new WebSocket(wsUrl);
          sock.onopen = () => console.log('Collab WS connected', wsUrl);
          sock.onerror = (e) => console.warn('Collab WS error', e);
          sock.onclose = () => console.log('Collab WS closed');
        } catch (e) {
          console.warn('Collab probe failed', e);
        }

        // Mount SuperDoc with the default document URL
        const mount = (doc) => mountSuperdoc({ selector: '#superdoc', toolbar: '#superdoc-toolbar', document: doc, documentMode: 'editing', pagination: true, rulers: true });
        const toolbar = document.getElementById('superdoc-toolbar');
        const container = document.getElementById('superdoc');
        const render = (doc) => {
          // Reset both toolbar and editor containers to avoid leftover state
          toolbar.innerHTML = '';
          container.innerHTML = '';
          // Normalize URL to absolute
          if (typeof doc === 'string') {
            try { doc = new URL(doc, location.origin).href; } catch {}
          }
          mount(doc);
        };
        // Initial load
        render('/documents/default.docx');
        // Listen for UI requests to open other docs
        window.addEventListener('superdoc:open-url', (e) => {
          try { render(e.detail?.url || '/documents/default.docx'); } catch(err) { console.warn('open-url failed', err); }
        });
        window.addEventListener('superdoc:open-file', (e) => {
          try { const f = e.detail?.file; if (f) render(f); } catch(err) { console.warn('open-file failed', err); }
        });
        // Mount shared UI in footer area
        mountApp({ rootSelector: '#app-root' });
      } catch (e) {
        const el = document.getElementById('superdoc');
        el.innerHTML = `<div style=\"padding:16px\">Failed to initialize: ${e?.message || e}.<br/>Open <a href=\"/debug\">/debug</a> to verify current document and uploads.</div>`;
        console.error('View init error', e);
      }
    });
  </script>
</head>
<body>
  <div id="banner">
    <div class="banner-inner">
      <span class="pill-left">Coming 2026</span>
      <!-- Optional logo could go here -->
      <div class="banner-title">Redline Like You Mean It: The Future of Contracting</div>
    </div>
  </div>
  <div id="layout">
    <div id="editor-col">
      <div id="superdoc-toolbar"></div>
      <div id="superdoc"></div>
    </div>
    <aside id="pane">
      <div id="app-root"></div>
    </aside>
  </div>
</body>
</html>

